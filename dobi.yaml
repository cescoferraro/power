meta:
    project: power
    default: all


mount=source:
    bind: .
    path: /go/src/github.com/cescoferraro/power

mount=dist:
    bind: ./dist/bin/
    path: /go/bin/

mount=device:
    bind: /dev/ttyACM0
    path: /dev/ttyACM0

mount=machine-id:
    bind: /var/lib/dbus/machine-id
    path: /var/lib/dbus/machine-id



image=watch-builder:
    image: cescoferraro/power
    tags: ["watch"]
    context: .
    dockerfile: docker/Dockerfile.watch


image=binary-builder:
    image: cescoferraro/power
    tags: ["builder"]
    context: .
    dockerfile: docker/Dockerfile.build

job=binary:
    use: binary-builder
    artifact: ./dist/bin/
    mounts: [source, dist]
    command: script/build
    env:
      - "POWER_JWT={env.POWER_JWT:}"
    description: "Build the ARM static binary"


image=release:
    image: cescoferraro/power
    tags: ["arm"]
    context: .
    dockerfile: docker/Dockerfile.release
    depends: [binary]


job=watch:
    use: watch-builder
    interactive: true
    net-mode: host
    devices: "/dev/ttyACM0"
    ports: ["5000:5000"]
    mounts: [source,machine-id,device]
    env:
      - "POWER_JWT={env.POWER_JWT:}"
    description: "Watch for code changes and run the unit tests"

job=deps:
    use: binary-builder
    mounts: [source]
    command: "glide install"
    sources: ['glide.yaml', 'glide.lock']
    artifact: vendor/
    description: "Install go dependencies"